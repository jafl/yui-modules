<!DOCTYPE HTML>
<html>
<head>
	<title>YUI 3 QueryBuilder Example</title>
	<meta http-equiv=content-type content="text/html; charset=utf-8">

	<script src="http://yui.yahooapis.com/3.15.0/build/yui/yui-min.js"></script>
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.15.0/build/cssreset/cssreset-min.css">

	<script src="gallery-datatable-paginator-debug.js"></script>
	<script src="gallery-object-extras-debug.js"></script>
<!--
	<script src="gallery-querybuilder-debug.js"></script>
	<script src="gallery-formmgr-debug.js"></script>
	<script src="gallery-formmgr-css-validation-debug.js"></script>
	<script src="gallery-node-optimizations-debug.js"></script>
	<script src="gallery-paginator-debug.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/gallery-querybuilder.css" />
	<link rel="stylesheet" type="text/css" href="assets/gallery-paginator.css" />
-->
	<style type="text/css">
	#query
	{
		margin: 10px 0;
	}

	#controls
	{
		margin: 10px 0;
	}

	.rpp
	{
		padding-left: 1.5em;
	}

	.yui3-skin-sam .yui3-datatable caption
	{
		padding: 0 !important;
	}

	.yui3-skin-sam .yui3-paginator-rpp-options
	{
		margin-left: 0;
	}
	</style>
</head>
<body class="yui3-skin-sam">

<h1><a href="http://yuilibrary.com/gallery/show/querybuilder">YUI 3 QueryBuilder</a> Example</h1>
<hr>

<form id="query-form" name="query_form">
	<div id="query"></div>
</form>

<div id="controls">
	<button id="apply">Apply</button>
	<button id="reset">Clear</button>
</div>

<div id="pg"></div>

<div id="table"></div>

<hr>
<p><a href="basic.html">Show me a simpler example using only QueryBuilder</a></p>
<p><a href="../yuidoc/modules/gallery-querybuilder.html">Show me the documentation</a></p>
<p><a href="/yui-modules/">Back to project list</a></p>

<script type="text/javascript">
YUI({
//	filter: 'raw', combine: false,
	gallery: 'gallery-2014.02.20-23-55'
}).use(
	'datatable-datasource',
	'datasource-arrayschema',
	'gallery-datatable-paginator',
	'gallery-querybuilder',
	'gallery-formmgr',
	'gallery-paginator',
	'array-extras',
function(Y)
{
	function generateRequest()
	{
		var state    = pg.getState();
		state.filter = query.toDatabaseQuery();
		return state;
	}

// Raw data

	var data =
	[
		{id:'n1', year:1950, quantity:10, title:"The Lion, the Witch and the Wardrobe"},
		{id:'n2', year:1951, quantity:5, title:"Prince Caspian: The Return to Narnia"},
		{id:'n3', year:1952, quantity:2, title:"The Voyage of the Dawn Treader"},
		{id:'n4', year:1953, quantity:6, title:"The Silver Chair"},
		{id:'n5', year:1954, quantity:9, title:"The Horse and His Boy"},
		{id:'n6', year:1955, quantity:4, title:"The Magician's Nephew"},
		{id:'n7', year:1956, quantity:8, title:"The Last Battle"},
		{id:'lsf1', year:1938, quantity:10, title:"Out of the Silent Planet"},
		{id:'lsf2', year:1943, quantity:5, title:"Perelandra"},
		{id:'lsf3', year:1945, quantity:2, title:"That Hideous Strength"},
		{id:'p1', year:1995, quantity:7, title:"Northern Lights"},
		{id:'p2', year:1997, quantity:5, title:"The Subtle Knife"},
		{id:'p3', year:2000, quantity:8, title:"The Amber Spyglass"},
		{id:'t0', year:1937, quantity:5, title:"The Hobbit"},
		{id:'t1', year:1955, quantity:12, title:"The Fellowship of the Ring"},
		{id:'t2', year:1955, quantity:0, title:"The Two Towers"},
		{id:'t3', year:1955, quantity:8, title:"The Return of the King"},
		{id:'pd', year:1966, quantity:5, title:"Do Androids Dream of Electric Sheep?"},
		{id:'h1', year:1959, quantity:4, title:"Starship Troopers"},
		{id:'h2', year:1961, quantity:7, title:"Stranger in a Strange Land"},
		{id:'h3', year:1966, quantity:3, title:"The Moon Is a Harsh Mistress"},
		{id:'v1', year:1946, quantity:3, title:"Slan"},
		{id:'v2', year:1950, quantity:5, title:"The Voyage of the Space Beagle"},
		{id:'v3', year:1970, quantity:8, title:"Quest for the Future"},
		{id:'d1', year:1859, quantity:5, title:"On the Origin of Species by Means of Natural Selection, or the Preservation of Favoured Races in the Struggle for Life"},
		{id:'d2', year:1881, quantity:2, title:"The Formation of Vegetable Mould through the Action of Worms"},
		{id:'e1', year:1905, quantity:8, title:"On a Heuristic Viewpoint Concerning the Production and Transformation of Light"},
		{id:'e2', year:1905, quantity:5, title:"On the Electrodynamics of Moving Bodies"},
		{id:'e3', year:1917, quantity:7, title:"Kosmologische Betrachtungen zur allgemeinen Relativit&auml;tstheorie"},
		{id:'e4', year:1935, quantity:3, title:"Can Quantum-Mechanical Description of Physical Reality Be Considered Complete?"},
		{id:'g1', year:1610, quantity:5, title:"Sidereus Nuncius"},
		{id:'g2', year:1615, quantity:2, title:"Letter to the Grand Duchess Christina"},
		{id:'g3', year:1632, quantity:6, title:"Dialogo sopra i due massimi sistemi del mondo"},
		{id:'i1', year:1671, quantity:7, title:"Method of Fluxions"},
		{id:'i2', year:1687, quantity:4, title:"Philosophi&aelig; Naturalis Principia Mathematica"},
		{id:'i3', year:1704, quantity:3, title:"Opticks"}
	];

// QueryBuilder

	var var_list =
	[
		{
			name: 'title',
			type: 'string',
			text: 'Title'
		},
		{
			name: 'year',
			type: 'number',
			text: 'Year',
			validation: 'yiv-integer:[0,2100]'
		},
		{
			name: 'quantity',
			type: 'number',
			text: 'Quantity',
			validation: 'yiv-integer:[0,]'
		}
	];

	var ops =
	{
		string:
		[
			{ value: 'contains',    text: 'Contains' },
			{ value: 'starts-with', text: 'Starts with' },
			{ value: 'ends-with',   text: 'Ends with' }
		],

		number:
		[
			{ value: 'equal',   text: '=' },
			{ value: 'less',    text: '<=' },
			{ value: 'greater', text: '>=' }
		]
	};

	var query = new Y.QueryBuilder(var_list, ops);
	query.render('#query');

	var form = new Y.FormManager('query_form');
	form.prepareForm();

	function filter(e)
	{
		e.halt();
		if (form.validateForm())
		{
			pg.setPage(1, true);
			sendRequest();
		}
	}

	Y.on('click', function()
	{
		query.reset();
		sendRequest();
	},
	'#reset');

	Y.on('click', filter, '#apply');
	Y.on('submit', filter, '#query-form');

	// filtering

	var filters =
	{
		string:
		{
			contains: function(value, filter)
			{
				return (value.toLowerCase().indexOf(filter.toLowerCase()) >= 0);
			},
			'starts-with': function(value, filter)
			{
				return (value.toLowerCase().substr(0, filter.length) == filter.toLowerCase());
			},
			'ends-with': function(value, filter)
			{
				return (value.toLowerCase().substr(-filter.length) == filter.toLowerCase());
			}
		},

		number:
		{
			equal: function(value, filter)
			{
				return (parseInt(value, 10) == parseInt(filter, 10));
			},
			less: function(value, filter)
			{
				return (parseInt(value, 10) <= parseInt(filter, 10));
			},
			greater: function(value, filter)
			{
				return (parseInt(value, 10) >= parseInt(filter, 10));
			}
		}
	};

	var var_type = {};
	for (var i=0; i<var_list.length; i++)
	{
		var_type[ var_list[i].name ] = var_list[i].type;
	}

	function filterData(
		/* array */	data,
		/* array */	filter)
	{
		for (var i=0; i<filter.length; i++)
		{
			data = applyFilter(data, filter[i]);
		}
		return data;
	}

	function applyFilter(
		/* array */	data,
		/* array */	filter)
	{
		var key  = filter[0];
		var op   = filter[1];
		var val  = filter[2];
		var type = var_type[key];

		return Y.Array.filter(data, function(v)
		{
			return filters[type][op](v[key], val);
		});
	}

// Data Source

	// Wrap ordinary data source to implement filtering and pagination.
	// (All DataSource*Schema plugins prevent DataSource._defDataFn from executing.)

	function FilterDataSource()
	{
		FilterDataSource.superclass.constructor.apply(this, arguments);
	}

	FilterDataSource.NAME = "filterdatasource";

	Y.extend(FilterDataSource, Y.DataSource.Local,
	{
		_defRequestFn: function(e)
		{
			var self    = this;
			var payload = e.details[0];

			this.get('source').sendRequest(
			{
				request: e.request,
				callback:
				{
					success: function(e1)
					{
						payload.data = e1.response.results;
						payload.meta = e1.response.meta;
						self.fire('data', payload);
					},
					failure: function(e1)
					{
						payload.error = e1.error;
						self.fire('data', payload);
					}
				}
			});
		},

		_defDataFn: function(e)
		{
			var data = filterData(e.data, e.request.filter);
			var response =
			{
				results: data.slice(e.request.recordOffset, e.request.recordOffset + e.request.rowsPerPage),
				meta:
				{
					totalRecords: data.length
				}
			};

			this.fire("response", Y.mix({response: response}, e));
		}
	});

	// configure data source

	var schema =
	{
		resultFields:
		[
			'quantity', 'year', 'title'
		]
	};

	var ds1 = new Y.DataSource.Local({source: data});
	ds1.plug(
	{
		fn:  Y.Plugin.DataSourceArraySchema,
		cfg: {schema:schema}
	});

	var ds = new FilterDataSource({source: ds1});

// Paginator

	var pg = new Y.Paginator(
	{
		totalRecords: 5,
		rowsPerPage: 5,
		template: '{FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} <span class="rpp">Rows per page:</span> {RowsPerPageDropdown}',
		rowsPerPageOptions:    [5,10],
		firstPageLinkLabel:    '|&lt;',
		previousPageLinkLabel: '&lt;',
		nextPageLinkLabel:     '&gt;',
		lastPageLinkLabel:     '&gt;|'
	});
	pg.render('#pg');

// DataTable

	var cols =
	[
		{ key: 'title', label: 'Title' },
		{ key: 'year', label: 'Year' },
		{ key: 'quantity', label: 'Quantity' }
	];

	var table = new Y.DataTable({columns: cols});
	table.plug(Y.Plugin.DataTableDataSource, {datasource: ds});
	table.plug(Y.Plugin.DataTablePaginator,
	{
		paginator:        pg,
		buildRequest:     generateRequest,
		totalRecordsExpr: '.meta.totalRecords'
	});
	table.render("#table");

	table.paginator.sendRequest();
});
</script>

</body>
</html>
