<!DOCTYPE HTML>
<html>
<head>
	<title>YUI 3 BulkEditor Example</title>
	<meta http-equiv=content-type content="text/html; charset=utf-8">

	<script src="https://jafl.github.io/yui3/build/yui/yui-min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://jafl.github.io/yui3/build/cssreset/cssreset-min.css" />
	<link rel="stylesheet" type="text/css" href="https://jafl.github.io/yui3/build/cssfonts/cssfonts-min.css" />
	<link rel="stylesheet" type="text/css" href="https://jafl.github.io/yui3/build/cssbase/cssbase-min.css" />

	<script src="gallery-bulkedit-debug.js"></script>
	<script src="gallery-formmgr-css-validation-debug.js"></script>
	<script src="gallery-paginator-debug.js"></script>
	<script src="gallery-checkboxgroups-debug.js"></script>
	<script src="gallery-busyoverlay-debug.js"></script>
	<script src="gallery-node-optimizations-debug.js"></script>
	<script src="gallery-object-extras-debug.js"></script>
	<script src="gallery-nodelist-extras2-debug.js"></script>
	<script src="gallery-chipper-debug.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/gallery-bulkedit.css" />
	<link rel="stylesheet" type="text/css" href="assets/gallery-paginator.css" />
	<link rel="stylesheet" type="text/css" href="assets/gallery-busyoverlay.css" />

	<style type="text/css">
	.yui3-js-enabled .yui3-widget-loading { display: none; }

	.yui3-skin-sam .yui3-htmltablebulkedit th { background-color: #EDEDED; }
	.yui3-skin-sam .yui3-htmltablebulkedit th,
	.yui3-skin-sam .yui3-htmltablebulkedit td { border-color: #C3C3C3; }
	.yui3-skin-sam .yui3-htmltablebulkedit-even { background-color: #EDEDED; }
	.yui3-skin-sam .yui3-htmltablebulkedit-odd.bulkedit-haserror { background-color: #FFEEEE; }
	.yui3-skin-sam .yui3-htmltablebulkedit-even.bulkedit-haserror { background-color: #FFDDDD; }
	.yui3-skin-sam .yui3-htmltablebulkedit .bulkedit-haserror .yui3-bulkedit-message-text { color: #BE1E2D; }
	.yui3-skin-sam .yui3-htmltablebulkedit .bulkedit-haswarn .yui3-bulkedit-message-text { color: darkorange; font-weight: bold; }

	#validate,
	#server,
	#filter { margin-left: 20px; }
	#server-note { display: none; }

	.yui3-skin-sam .yui3-htmltablebulkedit-cell-multi10 { white-space:nowrap; }
	</style>
</head>
<body class="yui3-skin-sam">

<h1>YUI 3 Bulk Editor Example</h1>
<p><a href="index.html">Show me a simpler example</a></p>
<p><a href="../yuidoc/modules/gallery-bulkedit.html">Show me the documentation</a></p>
<p><a href="/yui-modules/">Back to project list</a></p>
<hr>

<div id="controls">
	<button id="new">Add</button>
	<button id="clone">Clone</button>
	<button id="remove">Remove</button>
	<button id="validate">Validate</button>
	<button id="filter">Filter</button>
	<button id="server">Fake server errors</button>
	<button id="clear">Clear server errors</button>
	<span id="server-note">(Shift-reload the page to enable <q>Fake server errors</q>.)</span>
</div>

<div id="page-messages"></div>

<div id="pg"></div>

<div id="edit"></div>

<script type="text/javascript">
YUI({
//	filter: 'raw', combine: false,
	gallery: 'gallery-2014.02.20-23-55'
}).use(
	'gallery-bulkedit', 'datasource-arrayschema',
	'gallery-checkboxgroups', 'gallery-paginator',
	'gallery-nodelist-extras2',
	'gallery-multivalue-input',
	'autocomplete', 'autocomplete-filters', 'autocomplete-highlighters',
function(Y)
{
// Raw data

	var data =
	[
		{id:'n1', year:1950, quantity:10, title:"The Lion, the Witch and the Wardrobe", foo:"The", bar:"Lion@baz", color:"red", hue:4},
		{id:'n2', year:1951, quantity:5, title:"Prince Caspian: The Return to Narnia", foo:"Prince", bar:"Caspian@baz", color:"green", hue:1},
		{id:'n3', year:1952, quantity:2, title:"The Voyage of the Dawn Treader", foo:"The", bar:"Voyage@baz", color:"blue", hue:5},
		{id:'n4', year:1953, quantity:6, title:"The Silver Chair", foo:"The", bar:"Silver@baz", color:"red", hue:4},
		{id:'n5', year:1954, quantity:9, title:"The Horse and His Boy", foo:"The", bar:"Horse@baz", color:"green", hue:1},
		{id:'n6', year:1955, quantity:4, title:"The Magician's Nephew", foo:"The", bar:"Magician's@baz", color:"blue", hue:5},
		{id:'n7', year:1956, quantity:8, title:"The Last Battle", foo:"The", bar:"Last@baz", color:"red", hue:4},
		{id:'lsf1', year:1938, quantity:10, title:"Out of the Silent Planet", foo:"Out", bar:"of@baz", color:"green", hue:1},
		{id:'lsf2', year:1943, quantity:5, title:"Perelandra", foo:"A", bar:"B@baz", color:"blue", hue:5},
		{id:'lsf3', year:1945, quantity:2, title:"That Hideous Strength", foo:"That", bar:"Hideous@baz", color:"red", hue:4},
		{id:'p1', year:1995, quantity:7, title:"Northern Lights", foo:"Northern", bar:"Lights@baz", color:"green", hue:1},
		{id:'p2', year:1997, quantity:5, title:"The Subtle Knife", foo:"The", bar:"Subtle@baz", color:"blue", hue:5},
		{id:'p3', year:2000, quantity:8, title:"The Amber Spyglass", foo:"The", bar:"Amber@baz", color:"red", hue:4},
		{id:'t0', year:1937, quantity:5, title:"The Hobbit", foo:"The", bar:"Hobbit@baz", color:"green", hue:1},
		{id:'t1', year:1955, quantity:12, title:"The Fellowship of the Ring", foo:"The", bar:"Fellowship@baz", color:"blue", hue:5},
		{id:'t2', year:1955, quantity:0, title:"The Two Towers", foo:"The", bar:"Two@baz", color:"red", hue:4},
		{id:'t3', year:1955, quantity:8, title:"The Return of the King", foo:"The", bar:"Return@baz", color:"green", hue:1},
		{id:'pd', year:1966, quantity:5, title:"Do Androids Dream of Electric Sheep?", foo:"Do", bar:"Androids@baz", color:"blue", hue:5},
		{id:'h1', year:1959, quantity:4, title:"Starship Troopers", foo:"Starship", bar:"Troopers@baz", color:"red", hue:4},
		{id:'h2', year:1961, quantity:7, title:"Stranger in a Strange Land", foo:"Stranger", bar:"in@baz", color:"green", hue:1},
		{id:'h3', year:1966, quantity:3, title:"The Moon Is a Harsh Mistress", foo:"The", bar:"Moon@baz", color:""},
		{id:'v1', year:1946, quantity:3, title:"Slan", foo:"X", bar:"Y@baz", color:"red", hue:4},
		{id:'v2', year:1950, quantity:5, title:"The Voyage of the Space Beagle", foo:"The", bar:"Voyage@baz", color:"green", hue:1},
		{id:'v3', year:1970, quantity:8, title:"Quest for the Future", foo:"Quest", bar:"for@baz", color:"blue", hue:5},
		{id:'d1', year:1859, quantity:5, title:"On the Origin of Species by Means of Natural Selection, or the Preservation of Favoured Races in the Struggle for Life", foo:"On", bar:"the@baz", color:"red", hue:4},
		{id:'d2', year:1881, quantity:2, title:"The Formation of Vegetable Mould through the Action of Worms", foo:"The", bar:"Formation@baz", color:"green", hue:1},
		{id:'e1', year:1905, quantity:8, title:"On a Heuristic Viewpoint Concerning the Production and Transformation of Light", foo:"On", bar:"a@baz", color:"blue", hue:5},
		{id:'e2', year:1905, quantity:5, title:"On the Electrodynamics of Moving Bodies", foo:"On", bar:"the@baz", color:"red", hue:4},
		{id:'e3', year:1917, quantity:7, title:"Kosmologische Betrachtungen zur allgemeinen Relativit&auml;tstheorie", foo:"Kosmologische", bar:"Betrachtungen@baz", color:"green", hue:1},
		{id:'e4', year:1935, quantity:3, title:"Can Quantum-Mechanical Description of Physical Reality Be Considered Complete?", foo:"Can", bar:"Quantum-Mechanical@baz", color:"blue", hue:5},
		{id:'g1', year:1610, quantity:5, title:"Sidereus Nuncius", foo:"Sidereus", bar:"Nuncius@baz", color:"red", hue:4},
		{id:'g2', year:1615, quantity:2, title:"Letter to the Grand Duchess Christina", foo:"Letter", bar:"to@baz", color:"green", hue:1},
		{id:'g3', year:1632, quantity:6, title:"Dialogo sopra i due massimi sistemi del mondo", foo:"Dialogo", bar:"sopra@baz", color:"blue", hue:5},
		{id:'i1', year:1671, quantity:7, title:"Method of Fluxions", foo:"Method", bar:"of@baz", color:"red", hue:4},
		{id:'i2', year:1687, quantity:4, title:"Philosophi&aelig; Naturalis Principia Mathematica", foo:"Philosophi&aelig;", bar:"Naturalis@baz", color:"green", hue:1},
		{id:'i3', year:1704, quantity:3, title:"Opticks", foo:"G", bar:"H@baz", color:"blue", hue:5}
	];

	var states =
	[
		'Alabama',
		'Alaska',
		'Arizona',
		'Arkansas',
		'California',
		'Colorado',
		'Connecticut',
		'Delaware',
		'Florida',
		'Georgia',
		'Hawaii',
		'Idaho',
		'Illinois',
		'Indiana',
		'Iowa',
		'Kansas',
		'Kentucky',
		'Louisiana',
		'Maine',
		'Maryland',
		'Massachusetts',
		'Michigan',
		'Minnesota',
		'Mississippi',
		'Missouri',
		'Montana',
		'Nebraska',
		'Nevada',
		'New Hampshire',
		'New Jersey',
		'New Mexico',
		'New York',
		'North Dakota',
		'North Carolina',
		'Ohio',
		'Oklahoma',
		'Oregon',
		'Pennsylvania',
		'Rhode Island',
		'South Carolina',
		'South Dakota',
		'Tennessee',
		'Texas',
		'Utah',
		'Vermont',
		'Virginia',
		'Washington',
		'West Virginia',
		'Wisconsin',
		'Wyoming'
	];

// Field configuration

	var fields =
	{
		title:
		{
			type: 'textarea'
		},
		year:
		{
			validation:
			{
				css: 'yiv-integer:[1500,2100]'
			}
		},
		quantity:
		{
			validation:
			{
				css: 'yiv-integer:[0,]'
			}
		},
		color:
		{
			type: 'select',
			values:
			[
				{ value: 'red',   text: 'Red'   },
				{ value: 'green', text: 'Green' },
				{ value: 'blue',  text: 'Blue'  }
			]
		},
		hue:
		{
			type:   'select',
			values: [ ]
		},
		foo:
		{
			label: 'Foo',
			type: 'textarea'
		},
		bar:
		{
			label: 'Bar',
			validation:
			{
				regex: /.+@.+/,
				msg:
				{
					'regex': 'Please enter something that looks vaguely like an email address.'
				}
			}
		},
		baz: {},
		bork: {},
		multi10:
		{
			type:   'checkboxMultiselect',
			label:  '10 options',
			values: []
		},
		multi50:
		{
			type:   'autocompleteInputMultiselect',
			label:  '50 options',
			values: []
		}
	};

	for (var i=0; i<10; i++)
	{
		fields.multi10.values.push(
		{
			value: i,
			text:  states[i]
		});
	}

	for (var i=0; i<50; i++)
	{
		fields.multi50.values.push(
		{
			value: i,
			text:  states[i]
		});
	}

// Data source

	var schema =
	{
		resultFields:
		[
			"id",
			{
				key: "quantity",
				comparator: 'integer'
			},
			{
				key: "year",
				comparator: 'integer'
			},
			"title",
			"color",
			{
				key: "hue",
				comparator: 'integer'
			},
			"foo",
			"bar"
		]
	};

	var raw_ds = new Y.DataSource.Local({source: data});
	raw_ds.plug(
	{
		fn:  Y.Plugin.DataSourceArraySchema,
		cfg: {schema:schema}
	});

	var ds = new Y.DataSource.BulkEdit(
	{
		ds:                     raw_ds,
		uniqueIdKey:            'id',
		generateRequest:        function() { },			// local data source ignores request
		totalRecordsReturnExpr: '.meta.totalRecords',	// turns on pagination inside BulkEditDataSource
		extractTotalRecords:    function(response)
		{
			return response.meta.totalRecords;
		}
	});

// Column configuration

	function configureHueMenu(menu, color, hue)
	{
		var o    = Y.Node.getDOMNode(menu).options;
		o.length = 0;

		if (color == 'green')
		{
			o[0] = new Option('Lime', '1');
			o[1] = new Option('Grass', '2');
		}
		else
		{
			o[0] = new Option('Light', '4');
			o[1] = new Option('Dark', '5');

			if (color == 'blue')
			{
				menu.set('value', 5);
			}
		}

		if (!Y.Lang.isUndefined(hue))
		{
			menu.set('value', hue);
		}
	}

	var columns =
	[
		{
			key:       'checkbox',
			label:     '<input type="checkbox" id="select-all" />',
			formatter: function(o)
			{
				var markup = '<input type="checkbox" class="record-select" id="{id}" />';
				o.cell.set('innerHTML', Y.Lang.sub(markup,
				{
					id: this.getRecordId(o.record)
				}));
			}
		},
		{ key: 'title', label: 'Title' },
		{ key: 'year', label: 'Year' },
		{ key: 'quantity', label: 'Quantity' },
		{ key: 'color', label: 'Color' },
		{
			key:       'foobar',
			label:     'Stuff',
			formatter: function(o)
			{
				o.cell.set('innerHTML',
					Y.BulkEditor.fieldMarkup.call(this, 'baz', o.record) +
					Y.BulkEditor.fieldMarkup.call(this, 'hue', o.record) +
					Y.BulkEditor.fieldMarkup.call(this, 'foo', o.record) +
					Y.BulkEditor.fieldMarkup.call(this, 'bar', o.record));

				var menu = o.cell.getElementsByTagName('select').item(0);
				configureHueMenu(menu, o.record.color, o.record.hue);
			}
		},
		{ key: 'bork', label: 'Bork' },
		{ key: 'multi10', label: 'Checkboxes' },
		{ key: 'multi50', label: 'Multivalue input' }
	];

// Paginator

	var pg = new Y.Paginator(
	{
		rowsPerPage:10,
		rowsPerPageOptions:[1,2,5,10,25,50],
		firstPageLinkLabel:'|&lt;',
		previousPageLinkLabel:'&lt;',
		nextPageLinkLabel:'&gt;',
		lastPageLinkLabel:'&gt;|',
		pageLinks: Y.Paginator.VALUE_UNLIMITED,
		template:'{FirstPageLink}{PreviousPageLink}{ValidationPageLinks}{NextPageLink}{LastPageLink} {RowsPerPageDropdown}'
	});
	pg.render('#pg');

// BulkEditor extension with record-select checkboxes and extra row in each record

	function CustomBulkEditor()
	{
		CustomBulkEditor.superclass.constructor.apply(this, arguments);
	};

	CustomBulkEditor.NAME = 'custombulkeditor';

	Y.extend(CustomBulkEditor, Y.HTMLTableBulkEditor,
	{
		_render: function()
		{
			CustomBulkEditor.superclass._render.apply(this, arguments);
			Y.one('#select-all').set('checked', false);

			var cbs = this.get('contentBox').all('input.record-select');
			new Y.SelectAllCheckboxGroup('#select-all', cbs);
			new Y.EnableIfAnyCheckboxGroup(cbs.concat(Y.one('#select-all')), '#clone');
		},

		_renderRecordContainer: function(
			/* element */	container,
			/* object */	record)
		{
			var row  = CustomBulkEditor.superclass._renderRecordContainer.apply(this, arguments);

			var row2 = Y.Node.create('<tr class="custom-row"></tr>');
			row.get('parentNode').appendChild(row2);

			return row;
		},

		_renderRecord: function(
			/* element */	container,
			/* object */	record)
		{
			CustomBulkEditor.superclass._renderRecord.apply(this, arguments);

			var cell = Y.Node.create('<td class="custom-panel">You can add fields here by using Y.BulkEditor.fieldMarkup().</td>');
			cell.set('colSpan', columns.length);

			var row2 = container.siblings('.custom-row').item(0);
			row2.appendChild(cell);
		}
	});

// BulkEditor

	var editor = new CustomBulkEditor(
	{
		ds:        ds,
		fields:    fields,
		columns:   columns,
		paginator: pg,
		events:
		[
			{
				type:  'change',
				nodes: '.yui3-htmltablebulkedit-cell-color select',
				fn: function(e)
				{
					var hue = this.getFieldElement(e.target, 'hue');
					configureHueMenu(hue, e.target.get('value'));
				}
			}
		]
	});
	editor.render('#edit');

// Actions

	Y.on('click', function()
	{
		Y.one('#server').set('disabled', true);
		Y.one('#server-note').setStyle('display', 'inline');
		editor.saveChanges();

		var new_id = editor.insertRecord(ds.getRecordCount());

		editor.reload();
		editor.showRecordId(new_id);
	},
	'#new');

	function getSelectedItems()
	{
		var start = pg.getStartIndex();
		var list = editor.get('contentBox')
			.all('input.record-select')
			.map(function(node, i)
			{
				return { n: node, i: start + i };
			});

		return Y.Array.filter(list, function(item)
		{
			return item.n.get('checked');
		})
	}

	Y.on('click', function()
	{
		Y.one('#server').set('disabled', true);
		Y.one('#server-note').setStyle('display', 'inline');
		editor.saveChanges();

		var items = getSelectedItems();
		for (var i=items.length-1; i>=0; i--)
		{
			var item   = items[i];
			var new_id = editor.insertRecord(item.i+1, editor.getRecordId(item.n));
		}

		editor.reload();
		editor.showRecordId(new_id);
	},
	'#clone');

	Y.on('click', function()
	{
		Y.one('#server').set('disabled', true);
		Y.one('#server-note').setStyle('display', 'inline');
		editor.saveChanges();

		var items = getSelectedItems();
		for (var i=items.length-1; i>=0; i--)
		{
			editor.removeRecord(items[i].i);
		}

		if (editor.get('ds').getRecordCount() === 0)
		{
			editor.insertRecord(0);
		}

		editor.reload();
	},
	'#remove');

	Y.on('click', function()
	{
		editor.validate();
	},
	'#validate');

	var hidden_record_ids = [];
	Y.on('click', function()
	{
		editor.saveChanges();

		if (hidden_record_ids.length > 0)
		{
			Y.each(hidden_record_ids, function(id)
			{
				editor.showRecord(id);
			});
			hidden_record_ids = [];

			pg.setPage(1, true);
			editor.reload();
		}
		else
		{
			editor.getAllValues(
			{
				success: function(e)
				{
					var rec = e.response.results;
					for (var i=rec.length-1; i>=0; i--)
					{
						if (rec[i].title.substr(0,3).toLowerCase() != 'the' &&
							editor.hideRecord(i))
						{
							hidden_record_ids.push(rec[i].id);
						}
					}

					if (hidden_record_ids.length > 0)
					{
						Y.later(0, null, function()
						{
							pg.setPage(1, true);
							editor.reload();
						});
					}
				}
			});
		}
	},
	'#filter');

	Y.on('click', function()
	{
		editor.setServerErrors(
		[
			'Server is not available.',
			{ msg: 'Another fake message', type: 'info' }
		],
		[
			{
				id: 'n1'
			},
			{
				id: 'n2',
				recordError: 'We don\'t like it!'
			},
			{
				id: 'n3',
				fieldErrors:
				{
					title: { msg: 'Treacle tastes better', type: 'warn' },
					foo:   'Phooey!'
				}
			},
			{
				id: 'n4',
				recordError: { msg: 'Warning!', type: 'warn' }
			},
			{
				id: 'n5',
				fieldErrors:
				{
					title: { msg: 'No horseplay, please', type: 'warn' }
				}
			}
		]);
	},
	'#server');

	Y.on('click', function()
	{
		editor.clearServerErrors();
	},
	'#clear');

	function clearPageMessages()
	{
		Y.one('#page-messages').set('innerHTML', '');
	}

	editor.on('notifyErrors', function(e)
	{
		var s = Y.reduce(e.msgs, '', function(s, m)
		{
			if (Y.Lang.isString(m))
			{
				return s + '<li class="error">' + m + '</li>';
			}
			else
			{
				return s + '<li class="' + m.type + '">' + m.msg + '</li>';
			}
		});

		Y.one('#page-messages').set('innerHTML', '<ul>' + s + '</ul>');
	});

	editor.on('clearErrorNotification', function()
	{
		clearPageMessages();
	});
});
</script>

</body>
</html>
