<!DOCTYPE HTML>
<html>
<head>
	<title>YUI 3 BulkEditor Example</title>
	<meta http-equiv=content-type content="text/html; charset=utf-8">

	<script src="https://jafl.github.io/yui3/build/yui/yui-min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://jafl.github.io/yui3/build/cssreset/cssreset-min.css" />
	<link rel="stylesheet" type="text/css" href="https://jafl.github.io/yui3/build/cssfonts/cssfonts-min.css" />
	<link rel="stylesheet" type="text/css" href="https://jafl.github.io/yui3/build/cssbase/cssbase-min.css" />

	<script src="gallery-bulkedit-debug.js"></script>
	<script src="gallery-formmgr-css-validation-debug.js"></script>
	<script src="gallery-checkboxgroups-debug.js"></script>
	<script src="gallery-busyoverlay-debug.js"></script>
	<script src="gallery-node-optimizations-debug.js"></script>
	<script src="gallery-object-extras-debug.js"></script>
	<script src="gallery-nodelist-extras2-debug.js"></script>
	<script src="gallery-chipper-debug.js"></script>
	<link rel="stylesheet" type="text/css" href="assets/gallery-bulkedit.css" />
	<link rel="stylesheet" type="text/css" href="assets/gallery-busyoverlay.css" />

	<style type="text/css">
	.yui3-js-enabled .yui3-widget-loading { display: none; }

	.yui3-skin-sam .yui3-htmltablebulkedit th { background-color: #EDEDED; }
	.yui3-skin-sam .yui3-htmltablebulkedit th,
	.yui3-skin-sam .yui3-htmltablebulkedit td { border-color: #C3C3C3; }
	.yui3-skin-sam .yui3-htmltablebulkedit input,
	.yui3-skin-sam .yui3-htmltablebulkedit textarea,
	.yui3-skin-sam .yui3-htmltablebulkedit select { border: 1px #AAAAAA solid; }
	.yui3-skin-sam .yui3-htmltablebulkedit-even { background-color: #EDEDED; }
	.yui3-skin-sam .yui3-htmltablebulkedit-odd.bulkedit-haserror { background-color: #FFEEEE; }
	.yui3-skin-sam .yui3-htmltablebulkedit-even.bulkedit-haserror { background-color: #FFDDDD; }
	.yui3-skin-sam .yui3-htmltablebulkedit .bulkedit-haserror .yui3-bulkedit-message-text { color: #BE1E2D; }

	#validate { margin-left: 20px; }
	</style>
</head>
<body class="yui3-skin-sam">

<h1>YUI 3 Bulk Editor Example</h1>
<p><a href="complex.html">Show me a more complicated example</a></p>
<p><a href="../yuidoc/modules/gallery-bulkedit.html">Show me the documentation</a></p>
<p><a href="/yui-modules/">Back to project list</a></p>
<hr>

<div id="controls">
	<button id="new">Add</button>
	<button id="clone">Clone</button>
	<button id="remove">Remove</button>
	<button id="validate">Validate</button>
</div>

<div id="page-messages"></div>

<div id="edit"></div>

<script type="text/javascript">
YUI({
//	filter: 'raw', combine: false,
	gallery: 'gallery-2014.02.20-23-55'
}).use(
	'gallery-bulkedit', 'datasource-arrayschema',
	'gallery-checkboxgroups', 'gallery-nodelist-extras2',
function(Y)
{
// Raw data

	var data =
	[
		{id:'n1', year:1950, quantity:10, title:"The Lion, the Witch and the Wardrobe", foo:"The", bar:"Lion@baz", color:"red"},
		{id:'n2', year:1951, quantity:5, title:"Prince Caspian: The Return to Narnia", foo:"Prince", bar:"Caspian@baz", color:"green"},
		{id:'n3', year:1952, quantity:2, title:"The Voyage of the Dawn Treader", foo:"The", bar:"Voyage@baz", color:"blue"},
		{id:'n4', year:1953, quantity:6, title:"The Silver Chair", foo:"The", bar:"Silver@baz", color:"red"},
		{id:'n5', year:1954, quantity:9, title:"The Horse and His Boy", foo:"The", bar:"Horse@baz", color:"green"},
		{id:'n6', year:1955, quantity:4, title:"The Magician's Nephew", foo:"The", bar:"Magician's@baz", color:"blue"},
		{id:'n7', year:1956, quantity:8, title:"The Last Battle", foo:"The", bar:"Last@baz", color:"red"},
		{id:'lsf1', year:1938, quantity:10, title:"Out of the Silent Planet", foo:"Out", bar:"of@baz", color:"green"},
		{id:'lsf2', year:1943, quantity:5, title:"Perelandra", foo:"A", bar:"B@baz", color:"blue"},
		{id:'lsf3', year:1945, quantity:2, title:"That Hideous Strength", foo:"That", bar:"Hideous@baz", color:"red"},
		{id:'p1', year:1995, quantity:7, title:"Northern Lights", foo:"Northern", bar:"Lights@baz", color:"green"},
		{id:'p2', year:1997, quantity:5, title:"The Subtle Knife", foo:"The", bar:"Subtle@baz", color:"blue"},
		{id:'p3', year:2000, quantity:8, title:"The Amber Spyglass", foo:"The", bar:"Amber@baz", color:"red"},
		{id:'t0', year:1937, quantity:5, title:"The Hobbit", foo:"The", bar:"Hobbit@baz", color:"green"},
		{id:'t1', year:1955, quantity:12, title:"The Fellowship of the Ring", foo:"The", bar:"Fellowship@baz", color:"blue"},
		{id:'t2', year:1955, quantity:0, title:"The Two Towers", foo:"The", bar:"Two@baz", color:"red"},
		{id:'t3', year:1955, quantity:8, title:"The Return of the King", foo:"The", bar:"Return@baz", color:"green"},
		{id:'pd', year:1966, quantity:5, title:"Do Androids Dream of Electric Sheep?", foo:"Do", bar:"Androids@baz", color:"blue"},
		{id:'h1', year:1959, quantity:4, title:"Starship Troopers", foo:"Starship", bar:"Troopers@baz", color:"red"},
		{id:'h2', year:1961, quantity:7, title:"Stranger in a Strange Land", foo:"Stranger", bar:"in@baz", color:"green"},
		{id:'h3', year:1966, quantity:3, title:"The Moon Is a Harsh Mistress", foo:"The", bar:"Moon@baz", color:""},
		{id:'v1', year:1946, quantity:3, title:"Slan", foo:"X", bar:"Y@baz", color:"red"},
		{id:'v2', year:1950, quantity:5, title:"The Voyage of the Space Beagle", foo:"The", bar:"Voyage@baz", color:"green"},
		{id:'v3', year:1970, quantity:8, title:"Quest for the Future", foo:"Quest", bar:"for@baz", color:"blue"},
		{id:'d1', year:1859, quantity:5, title:"On the Origin of Species by Means of Natural Selection, or the Preservation of Favoured Races in the Struggle for Life", foo:"On", bar:"the@baz", color:"red"},
		{id:'d2', year:1881, quantity:2, title:"The Formation of Vegetable Mould through the Action of Worms", foo:"The", bar:"Formation@baz", color:"green"},
		{id:'e1', year:1905, quantity:8, title:"On a Heuristic Viewpoint Concerning the Production and Transformation of Light", foo:"On", bar:"a@baz", color:"blue"},
		{id:'e2', year:1905, quantity:5, title:"On the Electrodynamics of Moving Bodies", foo:"On", bar:"the@baz", color:"red"},
		{id:'e3', year:1917, quantity:7, title:"Kosmologische Betrachtungen zur allgemeinen Relativit&auml;tstheorie", foo:"Kosmologische", bar:"Betrachtungen@baz", color:"green"},
		{id:'e4', year:1935, quantity:3, title:"Can Quantum-Mechanical Description of Physical Reality Be Considered Complete?", foo:"Can", bar:"Quantum-Mechanical@baz", color:"blue"},
		{id:'g1', year:1610, quantity:5, title:"Sidereus Nuncius", foo:"Sidereus", bar:"Nuncius@baz", color:"red"},
		{id:'g2', year:1615, quantity:2, title:"Letter to the Grand Duchess Christina", foo:"Letter", bar:"to@baz", color:"green"},
		{id:'g3', year:1632, quantity:6, title:"Dialogo sopra i due massimi sistemi del mondo", foo:"Dialogo", bar:"sopra@baz", color:"blue"},
		{id:'i1', year:1671, quantity:7, title:"Method of Fluxions", foo:"Method", bar:"of@baz", color:"red"},
		{id:'i2', year:1687, quantity:4, title:"Philosophi&aelig; Naturalis Principia Mathematica", foo:"Philosophi&aelig;", bar:"Naturalis@baz", color:"green"},
		{id:'i3', year:1704, quantity:3, title:"Opticks", foo:"G", bar:"H@baz", color:"blue"}
	];

// Field configuration

	var fields =
	{
		title:
		{
			type: 'textarea'
		},
		year:
		{
			validation:
			{
				css: 'yiv-integer:[1500,2100]'
			}
		},
		quantity:
		{
			validation:
			{
				css: 'yiv-integer:[0,]'
			}
		},
		color:
		{
			type: 'select',
			values:
			[
				{ value: 'red',   text: 'Red'   },
				{ value: 'green', text: 'Green' },
				{ value: 'blue',  text: 'Blue'  }
			]
		},
		hue:
		{
			type: 'select',
			values:
			[
				{ value: 'light', text: 'Light' },
				{ value: 'dark',  text: 'Dark'  }
			]
		}
	};

// Data source

	var schema =
	{
		resultFields:
		[
			"id",
			{
				key: "quantity",
				comparator: 'integer'
			},
			{
				key: "year",
				comparator: 'integer'
			},
			"title",
			"color"
		]
	};

	var raw_ds = new Y.DataSource.Local({source: data});
	raw_ds.plug(
	{
		fn:  Y.Plugin.DataSourceArraySchema,
		cfg: {schema:schema}
	});

	var ds = new Y.DataSource.BulkEdit(
	{
		ds:                     raw_ds,
		uniqueIdKey:            'id',
		generateRequest:        function() { },			// local data source ignores request
		totalRecordsReturnExpr: '.meta.totalRecords',
		extractTotalRecords:    function(response)
		{
			return response.meta.totalRecords;
		}
	});

// Column configuration

	var columns =
	[
		{
			key:       'checkbox',
			label:     '<input type="checkbox" id="select-all" />',
			formatter: function(o)
			{
				var markup = '<input type="checkbox" class="record-select" id="{id}" />';
				o.cell.set('innerHTML', Y.Lang.sub(markup,
				{
					id: this.getRecordId(o.record)
				}));
			}
		},
		{ key: 'title', label: 'Title' },
		{ key: 'year', label: 'Year' },
		{ key: 'quantity', label: 'Quantity' },
		{ key: 'color', label: 'Color' },
		{ key: 'hue', label: 'Hue' }
	];

// BulkEditor extension with record-select checkboxes

	function CustomBulkEditor()
	{
		CustomBulkEditor.superclass.constructor.apply(this, arguments);
	};

	CustomBulkEditor.NAME = 'custombulkeditor';

	Y.extend(CustomBulkEditor, Y.HTMLTableBulkEditor,
	{
		_render: function()
		{
			CustomBulkEditor.superclass._render.apply(this, arguments);
			Y.one('#select-all').set('checked', false);

			var cbs = this.get('contentBox').all('input.record-select');
			new Y.SelectAllCheckboxGroup('#select-all', cbs);
			new Y.EnableIfAnyCheckboxGroup(cbs.concat(Y.one('#select-all')), '#clone');
		}
	});

// BulkEditor

	var editor = new CustomBulkEditor(
	{
		ds:        ds,
		fields:    fields,
		columns:   columns
	});
	editor.render('#edit');

// Actions

	Y.on('click', function()
	{
		editor.saveChanges();

		var new_id = editor.insertRecord(ds.getRecordCount());

		editor.reload();
		editor.showRecordId(new_id);
	},
	'#new');

	function getSelectedItems()
	{
		var list = editor.get('contentBox')
			.all('input.record-select')
			.map(function(node, i)
			{
				return { n: node, i: i };
			});

		return Y.Array.filter(list, function(item)
		{
			return item.n.get('checked');
		})
	}

	Y.on('click', function()
	{
		editor.saveChanges();

		var items = getSelectedItems();
		for (var i=items.length-1; i>=0; i--)
		{
			var item   = items[i];
			var new_id = editor.insertRecord(item.i+1, editor.getRecordId(item.n));
		}

		editor.reload();
		editor.showRecordId(new_id);
	},
	'#clone');

	Y.on('click', function()
	{
		editor.saveChanges();

		var items = getSelectedItems();
		for (var i=items.length-1; i>=0; i--)
		{
			editor.removeRecord(items[i].i);
		}

		if (editor.get('ds').getRecordCount() === 0)
		{
			editor.insertRecord(0);
		}

		editor.reload();
	},
	'#remove');

	Y.on('click', function()
	{
		editor.validate();
	},
	'#validate');

	function clearPageMessages()
	{
		Y.one('#page-messages').set('innerHTML', '');
	}

	editor.on('notifyErrors', function(e)
	{
		var s = Y.reduce(e.msgs, '', function(s, m)
		{
			if (Y.Lang.isString(m))
			{
				return s + '<li class="error">' + m + '</li>';
			}
			else
			{
				return s + '<li class="' + m.type + '">' + m.msg + '</li>';
			}
		});

		Y.one('#page-messages').set('innerHTML', '<ul>' + s + '</ul>');
	});

	editor.on('clearErrorNotification', function()
	{
		clearPageMessages();
	});
});
</script>

</body>
</html>
